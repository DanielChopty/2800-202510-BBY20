<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Poll Statistics - <%= user.name %>
  </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    .btn-site-blue {
      background-color: #003366 !important;
      color: #060505 !important;
      border: none !important;
      transition: background-color 0.3s ease;
    }

    .btn-site-blue:hover {
      background-color: #002244 !important;
    }

    .card-box {
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
      background-color: #ffffff;
    }

    .poll-title {
      font-size: 1.25rem;
      font-weight: bold;
    }

    .stat-info {
      font-size: 0.95rem;
      color: #6c757d;
    }

    .progress-label {
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .progress {
      height: 20px;
    }

    .btn-view-green {
      background-color: #198754 !important;
      color: #ffffff !important;
      border: none !important;
      transition: background-color 0.3s ease;
      font-size: 1.25rem;
      border-radius: 0.5rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.8rem;
    }

    .btn-view-green:hover {
      background-color: #146c43 !important;
    }

    .btn-view-square {
      width: 2.5rem;
      height: 2.5rem;
      color: #ffffff !important;
      background-color: #198754 !important;
      /* Bootstrap success green */
      border: none !important;
      font-size: 1.25rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: background-color 0.3s ease;
    }

    .btn-view-square:hover {
      background-color: #146c43 !important;
    }
  </style>
</head>

<body class="bg-light">
  <%- include('templates/header') %>

    <div class="container my-5">
      <div class="card shadow border-0 rounded-4 p-4">
        <h1 class="mb-4">Poll Statistics</h1>

        <!-- Sort Alphabetically -->
        <div class="d-flex justify-content-start gap-3 mb-3">
          <a href="/pollstats?sort=all" class="btn btn-site-blue text-white"
            style="<%= (!sort || sort === 'all') ? 'color: #ffffff !important; outline: 3px solid #FFD700; outline-offset: 2px;' : 'color: #ffffff !important;' %>">
            Sort Alphabetically
          </a>
        </div>

        <hr />

        <% if (polls.length===0) { %>
          <p class="text-muted">You haven't created any polls yet.</p>
          <% } else { %>
            <div class="list-group">
              <% polls.forEach(poll=> {
                // Views
                const views = poll.views || 0;
                const pollPercentRaw = maxViews > 0 ? (views / maxViews) * 100 : 0;
                const pollPercent = views === 0 ? 3 : Math.max(pollPercentRaw, 3);
                const avgPercentRaw = maxViews > 0 ? (averageViews / maxViews) * 100 : 0;
                const avgPercent = averageViews === 0 ? 3 : Math.max(avgPercentRaw, 3);
                let pollBarColor = '#fcd34d';
                if (views > averageViews) pollBarColor = '#198754';
                else if (views < averageViews && averageViews !==0) pollBarColor='#dc3545' ; // Saves const
                  saves=poll.savedBy?.length || 0; const savePercentRaw=maxSaves> 0 ? (saves / maxSaves) * 100 : 0;
                  const savePercent = saves === 0 ? 3 : Math.max(savePercentRaw, 3);
                  const avgSavePercentRaw = maxSaves > 0 ? (averageSaves / maxSaves) * 100 : 0;
                  const avgSavePercent = averageSaves === 0 ? 3 : Math.max(avgSavePercentRaw, 3);
                  let saveBarColor = '#fcd34d';
                  if (saves > averageSaves) saveBarColor = '#198754';
                  else if (saves < averageSaves && averageSaves !==0) saveBarColor='#dc3545' ; // Comments const
                    comments=poll.comments?.length || 0; const commentPercentRaw=maxComments> 0 ? (comments /
                    maxComments) * 100 : 0;
                    const commentPercent = comments === 0 ? 3 : Math.max(commentPercentRaw, 3);
                    const avgCommentPercentRaw = maxComments > 0 ? (averageComments / maxComments) * 100 : 0;
                    const avgCommentPercent = averageComments === 0 ? 3 : Math.max(avgCommentPercentRaw, 3);
                    let commentBarColor = '#fcd34d';
                    if (comments > averageComments) commentBarColor = '#198754';
                    else if (comments < averageComments && averageComments !==0) commentBarColor='#dc3545' ; %>

                      <div class="list-group-item list-group-item-action card-box">
                        <div class="d-flex justify-content-between align-items-start">
                          <div style="flex: 1;">
                            <div class="poll-title mb-3">
                              <%= poll.title %>
                            </div>

                            <!-- Views -->
                            <div class="stat-info mb-2 fw-bold">Views: This Poll vs. Your Average</div>
                            <div class="d-flex flex-column gap-2">
                              <div>
                                <div class="progress-label text-muted mb-1">This Poll</div>
                                <div class="progress">
                                  <div class="progress-bar" role="progressbar"
                                    style="width: <%= pollPercent %>%; background-color: <%= pollBarColor %>;"
                                    aria-valuenow="<%= views %>" aria-valuemin="0" aria-valuemax="<%= maxViews %>">
                                    <%= views %>
                                  </div>
                                </div>
                              </div>
                              <div>
                                <div class="progress-label text-muted mb-1">Your Average</div>
                                <div class="progress">
                                  <div class="progress-bar bg-secondary" role="progressbar"
                                    style="width: <%= avgPercent %>%;" aria-valuenow="<%= averageViews %>"
                                    aria-valuemin="0" aria-valuemax="<%= maxViews %>">
                                    <%= averageViews %>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Saves -->
                            <div class="stat-info mt-4 mb-2 fw-bold">Saves: This Poll vs. Your Average</div>
                            <div class="d-flex flex-column gap-2">
                              <div>
                                <div class="progress-label text-muted mb-1">This Poll</div>
                                <div class="progress">
                                  <div class="progress-bar" role="progressbar"
                                    style="width: <%= savePercent %>%; background-color: <%= saveBarColor %>;"
                                    aria-valuenow="<%= saves %>" aria-valuemin="0" aria-valuemax="<%= maxSaves %>">
                                    <%= saves %>
                                  </div>
                                </div>
                              </div>
                              <div>
                                <div class="progress-label text-muted mb-1">Your Average</div>
                                <div class="progress">
                                  <div class="progress-bar bg-secondary" role="progressbar"
                                    style="width: <%= avgSavePercent %>%;" aria-valuenow="<%= averageSaves %>"
                                    aria-valuemin="0" aria-valuemax="<%= maxSaves %>">
                                    <%= averageSaves %>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Comments -->
                            <div class="stat-info mt-4 mb-2 fw-bold">Comments: This Poll vs. Your Average</div>
                            <div class="d-flex flex-column gap-2">
                              <div>
                                <div class="progress-label text-muted mb-1">This Poll</div>
                                <div class="progress">
                                  <div class="progress-bar" role="progressbar"
                                    style="width: <%= commentPercent %>%; background-color: <%= commentBarColor %>;"
                                    aria-valuenow="<%= comments %>" aria-valuemin="0"
                                    aria-valuemax="<%= maxComments %>">
                                    <%= comments %>
                                  </div>
                                </div>
                              </div>
                              <div>
                                <div class="progress-label text-muted mb-1">Your Average</div>
                                <div class="progress">
                                  <div class="progress-bar bg-secondary" role="progressbar"
                                    style="width: <%= avgCommentPercent %>%;" aria-valuenow="<%= averageComments %>"
                                    aria-valuemin="0" aria-valuemax="<%= maxComments %>">
                                    <%= averageComments %>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Pie Chart Header -->
                            <div class="stat-info mt-4 mb-2 fw-bold">Results: Poll Options Breakdown</div>

                            <!-- Pie Chart Canvas -->
                            <canvas id="chart-<%= poll._id %>" width="400" height="300"></canvas>


                            <small class="d-block mt-4">Created on: <%= new Date(poll.createdAt).toLocaleDateString() %>
                            </small>
                          </div>

                          <!-- View details button -->
                          <div class="ms-3">
                            <a href="/poll/<%= poll._id %>" class="btn btn-view-square" title="View Extended Details">
                              <i class="bi bi-arrow-bar-right"></i>
                            </a>
                          </div>
                        </div>
                      </div>
                      <% }) %>

            </div>
            <% } %>
      </div>
    </div>

    <%- include('templates/footer') %>

      <!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    <% polls.forEach(poll => { 
      const chartId = `chart-${poll._id}`;
      const labels = poll.choices.map(choice => choice.text);
      const votes = poll.choices.map(choice => choice.votes);
    %>
      (function () {
        const ctx = document.getElementById("<%= chartId %>");
        if (ctx) {
          new Chart(ctx, {
            type: 'pie',
            data: {
              labels: <%- JSON.stringify(labels) %>,
              datasets: [{
                label: 'Votes',
                data: <%- JSON.stringify(votes) %>,
                backgroundColor: [
                  '#007bff', '#dc3545', '#ffc107', '#28a745',
                  '#6610f2', '#fd7e14', '#6f42c1', '#20c997'
                ],
                borderColor: '#ffffff',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || '';
                      const value = context.parsed || 0;
                      return `${label}: ${value} vote${value === 1 ? '' : 's'}`;
                    }
                  }
                }
              }
            }
          });
        }
      })();
    <% }); %>
  });
</script>

</body>

</html>